<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.170.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.170.0/examples/jsm/"
      }
    }
    </script>
    <title>San Francisco 3D Map Test</title>
    <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.127/Build/Cesium/Widgets/widgets.css">
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        #cesiumContainer { width: 100vw; height: 100vh; }
        #loading {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-family: Arial, sans-serif;
            font-size: 24px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div id="loading">Loading San Francisco 3D Model with World Terrain...</div>

    <script src="https://cesium.com/downloads/cesiumjs/releases/1.127/Build/Cesium/Cesium.js"></script>
    <script>
        console.log("Script started");

        try {
            const CESIUM_ION_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5NmY0YmQ5ZC01YjAzLTRlMjgtODNjNi03ODk0YzMzMzIwMjUiLCJpZCI6Mjg0MDk5LCJpYXQiOjE3NDE5MDA4MTV9.UBJTgisQzO6DOlzjlDbP2LC7QX4oclluTwzqhDUSWF0';
            const SF_3D_MODEL_ASSET_ID = 1415196; // Aerometrex San Francisco High Resolution 3D Model
            const WORLD_TERRAIN_ASSET_ID = 1; // Cesium World Terrain asset ID

            console.log("Setting Ion default access token");
            Cesium.Ion.defaultAccessToken = CESIUM_ION_TOKEN;

            console.log("Creating viewer");
            const viewer = new Cesium.Viewer('cesiumContainer', {
                baseLayerPicker: false,
                geocoder: false,
                homeButton: true,
                sceneModePicker: false,
                navigationHelpButton: true,
                animation: false,
                timeline: false,
                fullscreenButton: false,
                shadows: true
            });

            async function loadSceneAssets() {
                try {
                    console.log("Creating world terrain");
                    // Using CesiumTerrainProvider with the World Terrain asset ID
                    const worldTerrain = await Cesium.CesiumTerrainProvider.fromIonAssetId(WORLD_TERRAIN_ASSET_ID, {
                        requestWaterMask: true,
                        requestVertexNormals: true  // Required for terrain lighting
                    });
                    
                    console.log("Setting terrain provider");
                    viewer.terrainProvider = worldTerrain;
                    
                    // Enable terrain features
                    console.log("Enabling globe lighting");
                    viewer.scene.globe.enableLighting = true;
                    viewer.scene.globe.depthTestAgainstTerrain = true;
                    
                    // Load San Francisco 3D Model
                    console.log("Creating ion resource for 3D model");
                    const resource = await Cesium.IonResource.fromAssetId(SF_3D_MODEL_ASSET_ID);
                    console.log("Creating tileset with resource");
                    const tileset = await Cesium.Cesium3DTileset.fromUrl(resource);
                    
                    console.log("Tileset created successfully");
                    viewer.scene.primitives.add(tileset);
                    
                    // Set the camera to view San Francisco
                    // Coordinates for San Francisco: -122.4194, 37.7749
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(-122.4194, 37.7749, 1500),
                        orientation: {
                            heading: Cesium.Math.toRadians(20),  // Rotate a bit
                            pitch: Cesium.Math.toRadians(-30),   // Look down at terrain
                            roll: 0.0
                        }
                    });
                    
                    console.log("Zoom completed");
                    document.getElementById('loading').style.display = 'none';
                    console.log('San Francisco 3D Model with World Terrain loaded successfully');
                    
                } catch (error) {
                    console.error("Error during asset loading:", error);
                    document.getElementById('loading').textContent = 'Error: ' + error.message;
                }
            }
            
            loadSceneAssets();

        } catch (error) {
            console.error("Error during initialization:", error);
            document.getElementById('loading').textContent = 'Initialization Error: ' + error.message;
        }
    </script>
</body>
</html>